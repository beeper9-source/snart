<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>첼로 아카데미</title>
    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* 첼로 아카데미 앱 스타일 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app {
            min-height: 100vh;
        }

        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            width: 2rem;
            height: 2rem;
            color: #667eea;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
        }

        .progress-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        .lessons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .lesson-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .lesson-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
        }

        .lesson-card.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .lesson-card.completed {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .lesson-card.today {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .lesson-week {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #4a5568;
        }

        .week-icon {
            width: 1rem;
            height: 1rem;
            color: #667eea;
        }

        .lesson-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .completion-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .completion-toggle:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .check-icon {
            width: 1.25rem;
            height: 1.25rem;
            color: #9ca3af;
        }

        .check-icon.completed {
            color: #10b981;
        }

        .lesson-date {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .date-icon {
            width: 1rem;
            height: 1rem;
        }

        .days-remaining {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .lesson-content {
            margin-bottom: 1rem;
        }

        .lesson-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .lesson-composer {
            font-size: 0.875rem;
            color: #667eea;
            font-weight: 500;
        }

        .lesson-type {
            display: flex;
            justify-content: flex-end;
        }

        .type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .type-badge.suite {
            background: #dbeafe;
            color: #1e40af;
        }

        .type-badge.sonata {
            background: #fce7f3;
            color: #be185d;
        }

        .type-badge.piece {
            background: #fef3c7;
            color: #d97706;
        }

        .type-badge.rehearsal {
            background: #e0e7ff;
            color: #3730a3;
        }

        .type-badge.concert {
            background: #dcfce7;
            color: #166534;
        }

        .lesson-detail {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 120px;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .detail-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            line-height: 1.3;
            flex: 1;
            margin-right: 1rem;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-button:hover {
            background: #f3f4f6;
            color: #6b7280;
        }

        .detail-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .detail-info p {
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .detail-info strong {
            color: #4a5568;
            font-weight: 600;
        }

        .action-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-button:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .action-button.completed {
            background: #10b981;
        }

        .action-button.completed:hover {
            background: #059669;
        }

        .hidden {
            display: none;
        }

        /* 파일 업로드 관련 스타일 */
        .file-upload-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }

        .file-upload-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1rem;
        }

        .file-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            background: #f7fafc;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .file-upload-area.dragover {
            border-color: #667eea;
            background: #e6fffa;
        }

        .upload-icon {
            width: 2rem;
            height: 2rem;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .upload-text {
            color: #4a5568;
            font-size: 0.875rem;
        }

        .file-input {
            display: none;
        }

        .upload-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 0.5rem;
        }

        .upload-button:hover {
            background: #5a67d8;
        }

        .upload-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .upload-progress {
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .upload-progress-bar {
            height: 100%;
            background: #667eea;
            transition: width 0.3s ease;
        }

        .uploaded-files {
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: #f7fafc;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .file-icon {
            width: 1.25rem;
            height: 1.25rem;
            color: #667eea;
        }

        .file-name {
            font-size: 0.875rem;
            color: #2d3748;
            font-weight: 500;
        }

        .file-size {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .file-actions {
            display: flex;
            gap: 0.5rem;
        }

        .file-action-button {
            background: none;
            border: none;
            padding: 0.25rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .file-action-button:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .play-button {
            color: #10b981;
        }

        .download-button {
            color: #3b82f6;
        }

        .delete-button {
            color: #ef4444;
        }

        .audio-player {
            width: 100%;
            margin-top: 0.5rem;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: #f7fafc;
            border-radius: 6px;
        }

        .play-pause-button {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
        }

        .play-pause-button:hover {
            background: #059669;
            transform: scale(1.05);
        }

        .play-pause-button.playing {
            background: #ef4444;
        }

        .play-pause-button.playing:hover {
            background: #dc2626;
        }

        .audio-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .audio-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #2d3748;
        }

        .audio-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-bar-audio {
            flex: 1;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-fill-audio {
            height: 100%;
            background: #10b981;
            transition: width 0.1s ease;
        }

        .time-display {
            font-size: 0.75rem;
            color: #6b7280;
            font-family: monospace;
            min-width: 80px;
            text-align: right;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .volume-slider {
            width: 60px;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            cursor: pointer;
        }

        .no-files {
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 6px;
        }

        /* 연습 체크 관련 스타일 */
        .practice-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }

        .practice-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1rem;
        }

        .practice-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .practice-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            font-weight: 500;
            position: relative;
        }

        .practice-day.today {
            background: #fef3c7;
            color: #d97706;
            border: 2px solid #f59e0b;
        }

        .practice-day.past {
            background: #f3f4f6;
            color: #6b7280;
        }

        .practice-day.future {
            background: #f9fafb;
            color: #9ca3af;
        }

        .practice-day.practiced {
            background: #dcfce7;
            color: #166534;
        }

        .practice-day.practiced.today {
            background: #bbf7d0;
            color: #15803d;
        }

        .practice-day:hover {
            transform: scale(1.05);
        }

        .practice-day.future {
            cursor: pointer; /* 미래 날짜도 클릭 가능하도록 수정 */
        }

        .practice-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f7fafc;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .practice-stats {
            display: flex;
            gap: 1rem;
        }

        .practice-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .practice-stat-icon {
            width: 1rem;
            height: 1rem;
        }

        .practice-streak {
            color: #059669;
            font-weight: 600;
        }

        .practice-total {
            color: #3b82f6;
            font-weight: 600;
        }

        /* 반응형 디자인 */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .lesson-detail {
                position: static;
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 1rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .progress-section {
                align-items: flex-start;
                width: 100%;
            }
            
            .progress-bar {
                width: 100%;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .lessons-grid {
                grid-template-columns: 1fr;
            }
            
            .lesson-detail {
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .logo h1 {
                font-size: 1.5rem;
            }
            
            .lesson-card {
                padding: 1rem;
            }
            
            .lesson-title {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <svg class="logo-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                    </svg>
                    <h1>첼로 아카데미</h1>
                </div>
                <div class="progress-section">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="progress-text" id="progressText">0 / 16 강의 완료 (0%)</span>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="lessons-grid" id="lessonsGrid">
                <!-- 강의 카드들이 여기에 동적으로 생성됩니다 -->
            </div>

            <div class="lesson-detail hidden" id="lessonDetail">
                <div class="detail-header">
                    <h2 id="detailTitle"></h2>
                    <button class="close-button" onclick="closeDetail()">×</button>
                </div>
                <div class="detail-content">
                    <div class="detail-info" id="detailInfo">
                        <!-- 상세 정보가 여기에 표시됩니다 -->
                    </div>
                    <div class="detail-actions">
                        <button class="action-button" id="actionButton" onclick="toggleCompletion()"></button>
                    </div>
                </div>
                
                <!-- 파일 업로드 섹션 -->
                <div class="file-upload-section">
                    <h3 class="file-upload-title">레슨 녹음 파일</h3>
                    
                    <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <div class="upload-text">
                            <div>파일을 드래그하거나 클릭하여 업로드</div>
                            <div style="font-size: 0.75rem; margin-top: 0.25rem;">MP3, WAV, M4A 파일 지원</div>
                        </div>
                        <button class="upload-button" id="uploadButton" onclick="event.stopPropagation(); uploadFile()" disabled>
                            업로드
                        </button>
                    </div>
                    
                    <input type="file" id="fileInput" class="file-input" accept="audio/*" onchange="handleFileSelect(event)">
                    
                    <div class="upload-progress hidden" id="uploadProgress">
                        <div class="upload-progress-bar" id="uploadProgressBar"></div>
                    </div>
                    
                    <div class="uploaded-files" id="uploadedFiles">
                        <div class="no-files">아직 업로드된 파일이 없습니다.</div>
                    </div>
                </div>
                
                <!-- 연습 체크 섹션 -->
                <div class="practice-section">
                    <h3 class="practice-title">일자별 연습 체크</h3>
                    
                    <div class="practice-calendar" id="practiceCalendar">
                        <!-- 연습 달력이 여기에 동적으로 생성됩니다 -->
                    </div>
                    
                    <div class="practice-summary">
                        <div class="practice-stats">
                            <div class="practice-stat">
                                <svg class="practice-stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                <span class="practice-streak" id="practiceStreak">0일 연속</span>
                            </div>
                            <div class="practice-stat">
                                <svg class="practice-stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="practice-total" id="practiceTotal">총 0일 연습</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Supabase 설정
        const SUPABASE_URL = 'https://dmgtwzbvpualecnrcyug.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtZ3R3emJ2cHVhbGVjbnJjeXVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxMzAzODUsImV4cCI6MjA3MjcwNjM4NX0.Cddfcij0GL3lLCZz51tALcyKULfGECyq4YNpjVh9Uf4';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // 첼로 아카데미 강의 일정 데이터
        const lessons = [
            {
                id: 1,
                week: 1,
                date: '2025-08-06',
                title: 'Cello Suite 1 BWV 1007 Prelude 1, Allegro Moderato 알레그로 모데라토 1',
                composer: 'J.S. Bach',
                type: 'suite',
                completed: false,
                description: '바흐의 첫 번째 첼로 모음곡 프렐류드 첫 번째 부분을 학습합니다.'
            },
            {
                id: 2,
                week: 2,
                date: '2025-08-13',
                title: 'Cello Suite 1 BWV 1007 Prelude 1, Allegro Moderato 알레그로 모데라토 2',
                composer: 'J.S. Bach',
                type: 'suite',
                completed: false,
                description: '바흐의 첫 번째 첼로 모음곡 프렐류드 두 번째 부분을 학습합니다.'
            },
            {
                id: 3,
                week: 3,
                date: '2025-08-20',
                title: '브레발 첼로 소나타 1',
                composer: 'Jean-Baptiste Bréval',
                type: 'sonata',
                completed: false,
                description: '브레발의 첫 번째 첼로 소나타를 학습합니다.'
            },
            {
                id: 4,
                week: 4,
                date: '2025-08-27',
                title: '브레발 첼로 소나타 2',
                composer: 'Jean-Baptiste Bréval',
                type: 'sonata',
                completed: false,
                description: '브레발의 두 번째 첼로 소나타를 학습합니다.'
            },
            {
                id: 5,
                week: 5,
                date: '2025-09-03',
                title: '브레발 첼로 소나타 3',
                composer: 'Jean-Baptiste Bréval',
                type: 'sonata',
                completed: false,
                description: '브레발의 세 번째 첼로 소나타를 학습합니다.'
            },
            {
                id: 6,
                week: 6,
                date: '2025-09-10',
                title: '브레발 첼로 소나타 4',
                composer: 'Jean-Baptiste Bréval',
                type: 'sonata',
                completed: false,
                description: '브레발의 네 번째 첼로 소나타를 학습합니다.'
            },
            {
                id: 7,
                week: 7,
                date: '2025-09-17',
                title: '마르첼로 첼로 소나타 1',
                composer: 'Benedetto Marcello',
                type: 'sonata',
                completed: false,
                description: '마르첼로의 첫 번째 첼로 소나타를 학습합니다.'
            },
            {
                id: 8,
                week: 8,
                date: '2025-09-24',
                title: '마르첼로 첼로 소나타 2',
                composer: 'Benedetto Marcello',
                type: 'sonata',
                completed: false,
                description: '마르첼로의 두 번째 첼로 소나타를 학습합니다.'
            },
            {
                id: 9,
                week: 9,
                date: '2025-10-01',
                title: '마르첼로 첼로 소나타 3',
                composer: 'Benedetto Marcello',
                type: 'sonata',
                completed: false,
                description: '마르첼로의 세 번째 첼로 소나타를 학습합니다.'
            },
            {
                id: 10,
                week: 10,
                date: '2025-10-15',
                title: '마르첼로 첼로 소나타 4',
                composer: 'Benedetto Marcello',
                type: 'sonata',
                completed: false,
                description: '마르첼로의 네 번째 첼로 소나타를 학습합니다.'
            },
            {
                id: 11,
                week: 11,
                date: '2025-10-22',
                title: '바흐 무반주 첼로 모음곡 Minuets 1',
                composer: 'J.S. Bach',
                type: 'suite',
                completed: false,
                description: '바흐의 무반주 첼로 모음곡 미뉴엣 첫 번째 부분을 학습합니다.'
            },
            {
                id: 12,
                week: 12,
                date: '2025-10-29',
                title: '바흐 무반주 첼로 모음곡 Minuets 2',
                composer: 'J.S. Bach',
                type: 'suite',
                completed: false,
                description: '바흐의 무반주 첼로 모음곡 미뉴엣 두 번째 부분을 학습합니다.'
            },
            {
                id: 13,
                week: 13,
                date: '2025-11-05',
                title: 'Chanson Triste 1',
                composer: 'Pyotr Ilyich Tchaikovsky',
                type: 'piece',
                completed: false,
                description: '차이코프스키의 슬픈 노래 첫 번째 부분을 학습합니다.'
            },
            {
                id: 14,
                week: 14,
                date: '2025-11-12',
                title: 'Chanson Triste 2',
                composer: 'Pyotr Ilyich Tchaikovsky',
                type: 'piece',
                completed: false,
                description: '차이코프스키의 슬픈 노래 두 번째 부분을 학습합니다.'
            },
            {
                id: 15,
                week: 15,
                date: '2025-11-19',
                title: '리허설',
                composer: 'Various',
                type: 'rehearsal',
                completed: false,
                description: '클래스 연주회를 위한 전체 리허설을 진행합니다.'
            },
            {
                id: 16,
                week: 16,
                date: '2025-11-26',
                title: '클래스 연주회',
                composer: 'Various',
                type: 'concert',
                completed: false,
                description: '16주간의 학습 성과를 보여주는 클래스 연주회입니다.'
            }
        ];

        let completedLessons = new Set();
        let selectedLesson = null;
        let selectedFile = null;
        let uploadedFiles = new Map(); // lessonId -> files array
        let currentAudio = null; // 현재 재생 중인 오디오
        let currentAudioElement = null; // 현재 오디오 엘리먼트
        let audioElements = new Map(); // filePath -> audio element 매핑
        let practiceRecords = new Map(); // lessonId -> practice dates array

        // 날짜 포맷팅 함수
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'short' 
            };
            return date.toLocaleDateString('ko-KR', options);
        }

        // 강의 상태 확인 함수
        function getLessonStatus(lesson) {
            const lessonDate = new Date(lesson.date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            lessonDate.setHours(0, 0, 0, 0);
            
            if (completedLessons.has(lesson.id)) {
                return 'completed';
            } else if (lessonDate < today) {
                return 'past';
            } else if (lessonDate > today) {
                return 'upcoming';
            } else {
                return 'today';
            }
        }

        // 상태 색상 반환 함수
        function getStatusColor(status) {
            switch (status) {
                case 'completed': return '#10b981';
                case 'today': return '#f59e0b';
                case 'past': return '#6b7280';
                case 'upcoming': return '#3b82f6';
                default: return '#6b7280';
            }
        }

        // 상태 텍스트 반환 함수
        function getStatusText(status) {
            switch (status) {
                case 'completed': return '완료';
                case 'today': return '오늘';
                case 'past': return '지난 강의';
                case 'upcoming': return '예정';
                default: return '';
            }
        }

        // 남은 일수 계산 함수
        function getDaysRemaining(lessonDate) {
            const today = new Date();
            const lesson = new Date(lessonDate);
            const diffTime = lesson - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // 남은 일수 텍스트 반환 함수
        function getDaysRemainingText(lessonDate) {
            const days = getDaysRemaining(lessonDate);
            if (days < 0) return '';
            if (days === 0) return '오늘';
            if (days === 1) return '내일';
            return `${days}일 후`;
        }

        // 타입 텍스트 반환 함수
        function getTypeText(type) {
            switch (type) {
                case 'suite': return '모음곡';
                case 'sonata': return '소나타';
                case 'piece': return '곡';
                case 'rehearsal': return '리허설';
                case 'concert': return '연주회';
                default: return type;
            }
        }

        // 진행률 업데이트 함수
        function updateProgress() {
            const progressPercentage = (completedLessons.size / lessons.length) * 100;
            document.getElementById('progressFill').style.width = `${progressPercentage}%`;
            document.getElementById('progressText').textContent = 
                `${completedLessons.size} / ${lessons.length} 강의 완료 (${Math.round(progressPercentage)}%)`;
        }

        // 강의 카드 생성 함수
        function createLessonCard(lesson) {
            const status = getLessonStatus(lesson);
            const isSelected = selectedLesson?.id === lesson.id;
            
            return `
                <div class="lesson-card ${status} ${isSelected ? 'selected' : ''}" onclick="selectLesson(${lesson.id})">
                    <div class="lesson-header">
                        <div class="lesson-week">
                            <svg class="week-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span>${lesson.week}주차</span>
                        </div>
                        <div class="lesson-status">
                            <span class="status-badge" style="background-color: ${getStatusColor(status)}">
                                ${getStatusText(status)}
                            </span>
                            <button class="completion-toggle" onclick="event.stopPropagation(); toggleLessonCompletion(${lesson.id})">
                                ${completedLessons.has(lesson.id) ? 
                                    '<svg class="check-icon completed" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : 
                                    '<svg class="check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path></svg>'
                                }
                            </button>
                        </div>
                    </div>

                    <div class="lesson-date">
                        <svg class="date-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>${formatDate(lesson.date)}</span>
                        ${status === 'upcoming' ? `<span class="days-remaining">${getDaysRemainingText(lesson.date)}</span>` : ''}
                    </div>

                    <div class="lesson-content">
                        <h3 class="lesson-title">${lesson.title}</h3>
                        <p class="lesson-composer">${lesson.composer}</p>
                    </div>

                    <div class="lesson-type">
                        <span class="type-badge ${lesson.type}">
                            ${getTypeText(lesson.type)}
                        </span>
                    </div>
                </div>
            `;
        }

        // 강의 목록 렌더링 함수
        function renderLessons() {
            const lessonsGrid = document.getElementById('lessonsGrid');
            
            // 강의를 정렬: 완료된 강의를 위에, 최근 완료된 것을 맨 위로
            const sortedLessons = [...lessons].sort((a, b) => {
                const aCompleted = completedLessons.has(a.id);
                const bCompleted = completedLessons.has(b.id);
                
                // 완료 상태가 다르면 완료된 것을 위에
                if (aCompleted !== bCompleted) {
                    return aCompleted ? -1 : 1;
                }
                
                // 둘 다 완료된 경우: 주차가 높은 것(최근)을 위로
                if (aCompleted && bCompleted) {
                    return b.week - a.week;
                }
                
                // 둘 다 미완료인 경우: 주차 순으로 정렬
                return a.week - b.week;
            });
            
            lessonsGrid.innerHTML = sortedLessons.map(lesson => createLessonCard(lesson)).join('');
        }

        // 강의 선택 함수
        function selectLesson(lessonId) {
            selectedLesson = lessons.find(lesson => lesson.id === lessonId);
            showDetail();
        }

        // 상세보기 표시 함수
        async function showDetail() {
            if (!selectedLesson) return;
            
            const detailElement = document.getElementById('lessonDetail');
            const titleElement = document.getElementById('detailTitle');
            const infoElement = document.getElementById('detailInfo');
            const buttonElement = document.getElementById('actionButton');
            
            titleElement.textContent = selectedLesson.title;
            infoElement.innerHTML = `
                <p><strong>작곡가:</strong> ${selectedLesson.composer}</p>
                <p><strong>일정:</strong> ${formatDate(selectedLesson.date)}</p>
                <p><strong>주차:</strong> ${selectedLesson.week}주차</p>
                <p><strong>설명:</strong> ${selectedLesson.description}</p>
            `;
            
            const isCompleted = completedLessons.has(selectedLesson.id);
            buttonElement.textContent = isCompleted ? '완료 취소' : '완료 표시';
            buttonElement.className = `action-button ${isCompleted ? 'completed' : ''}`;
            
            detailElement.classList.remove('hidden');
            renderLessons(); // 선택 상태 업데이트
            
            // 해당 강의의 파일 목록 로드
            await loadLessonFiles(selectedLesson.id);
            renderUploadedFiles();
            
            // 해당 강의의 연습 기록 로드
            await loadPracticeRecords(selectedLesson.id);
            generatePracticeCalendar(selectedLesson.id);
            updatePracticeStats(selectedLesson.id);
        }

        // 상세보기 닫기 함수
        function closeDetail() {
            selectedLesson = null;
            document.getElementById('lessonDetail').classList.add('hidden');
            renderLessons(); // 선택 상태 업데이트
        }

        // 완료 상태 토글 함수
        async function toggleLessonCompletion(lessonId) {
            const isCompleted = completedLessons.has(lessonId);
            const newStatus = !isCompleted;
            
            try {
                if (newStatus) {
                    // 완료 상태로 변경
                    completedLessons.add(lessonId);
                    await saveLessonCompletion(lessonId, true);
                } else {
                    // 미완료 상태로 변경
                    completedLessons.delete(lessonId);
                    await saveLessonCompletion(lessonId, false);
                }
                
                updateProgress();
                renderLessons();
                
                // 현재 선택된 강의가 있다면 상세보기도 업데이트
                if (selectedLesson && selectedLesson.id === lessonId) {
                    showDetail();
                }
                
            } catch (error) {
                console.error('완료 상태 저장 오류:', error);
                alert('완료 상태 저장 중 오류가 발생했습니다.');
                
                // 오류 발생 시 원래 상태로 되돌리기
                if (newStatus) {
                    completedLessons.delete(lessonId);
                } else {
                    completedLessons.add(lessonId);
                }
                updateProgress();
                renderLessons();
            }
        }

        // 강의 완료 상태를 데이터베이스에 저장
        async function saveLessonCompletion(lessonId, isCompleted) {
            try {
                // 기존 완료 상태 확인
                const { data: existingData, error: selectError } = await supabaseClient
                    .from('lesson_completions')
                    .select('id')
                    .eq('lesson_id', lessonId)
                    .single();

                if (selectError && selectError.code !== 'PGRST116') { // PGRST116은 "not found" 오류
                    throw selectError;
                }

                if (isCompleted) {
                    if (existingData) {
                        // 기존 레코드가 있으면 업데이트
                        const { error: updateError } = await supabaseClient
                            .from('lesson_completions')
                            .update({ 
                                completed: true, 
                                completed_at: new Date().toISOString() 
                            })
                            .eq('lesson_id', lessonId);
                        
                        if (updateError) throw updateError;
                    } else {
                        // 새 레코드 생성
                        const { error: insertError } = await supabaseClient
                            .from('lesson_completions')
                            .insert({
                                lesson_id: lessonId,
                                completed: true,
                                completed_at: new Date().toISOString()
                            });
                        
                        if (insertError) throw insertError;
                    }
                } else {
                    if (existingData) {
                        // 완료 상태를 false로 업데이트
                        const { error: updateError } = await supabaseClient
                            .from('lesson_completions')
                            .update({ 
                                completed: false, 
                                completed_at: null 
                            })
                            .eq('lesson_id', lessonId);
                        
                        if (updateError) throw updateError;
                    }
                }
            } catch (error) {
                console.error('데이터베이스 저장 오류:', error);
                throw error;
            }
        }

        // 강의 완료 상태를 데이터베이스에서 로드
        async function loadLessonCompletions() {
            try {
                const { data, error } = await supabaseClient
                    .from('lesson_completions')
                    .select('lesson_id, completed')
                    .eq('completed', true);

                if (error) {
                    console.error('완료 상태 로드 오류:', error);
                    return;
                }

                // 완료된 강의들을 Set에 추가
                if (data) {
                    data.forEach(item => {
                        completedLessons.add(item.lesson_id);
                    });
                }
            } catch (error) {
                console.error('완료 상태 로드 오류:', error);
            }
        }

        // 완료 상태 토글 함수 (상세보기에서)
        function toggleCompletion() {
            if (selectedLesson) {
                toggleLessonCompletion(selectedLesson.id);
            }
        }

        // 파일 선택 처리 함수
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('uploadButton').disabled = false;
                
                // 파일 크기 확인 (50MB 제한)
                if (file.size > 50 * 1024 * 1024) {
                    alert('파일 크기는 50MB를 초과할 수 없습니다.');
                    selectedFile = null;
                    document.getElementById('uploadButton').disabled = true;
                    return;
                }
                
                // 오디오 파일 형식 확인
                if (!file.type.startsWith('audio/')) {
                    alert('오디오 파일만 업로드할 수 있습니다.');
                    selectedFile = null;
                    document.getElementById('uploadButton').disabled = true;
                    return;
                }
            }
        }

        // 파일 업로드 함수
        async function uploadFile() {
            if (!selectedFile || !selectedLesson) return;
            
            const uploadButton = document.getElementById('uploadButton');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadProgressBar = document.getElementById('uploadProgressBar');
            
            uploadButton.disabled = true;
            uploadProgress.classList.remove('hidden');
            
            try {
                // 파일명 생성 (lessonId_timestamp.extension)
                const timestamp = Date.now();
                const fileExtension = selectedFile.name.split('.').pop();
                const fileName = `lesson_${selectedLesson.id}_${timestamp}.${fileExtension}`;
                
                // Supabase Storage에 파일 업로드
                const { data, error } = await supabaseClient.storage
                    .from('lesson-recordings')
                    .upload(fileName, selectedFile, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (error) {
                    throw error;
                }
                
                // 데이터베이스에 파일 정보 저장
                const { error: dbError } = await supabaseClient
                    .from('lesson_files')
                    .insert({
                        lesson_id: selectedLesson.id,
                        file_name: fileName,
                        original_name: selectedFile.name,
                        file_size: selectedFile.size,
                        file_path: data.path,
                        uploaded_at: new Date().toISOString()
                    });
                
                if (dbError) {
                    throw dbError;
                }
                
                // 로컬 상태 업데이트
                if (!uploadedFiles.has(selectedLesson.id)) {
                    uploadedFiles.set(selectedLesson.id, []);
                }
                
                uploadedFiles.get(selectedLesson.id).push({
                    id: timestamp,
                    fileName: fileName,
                    originalName: selectedFile.name,
                    fileSize: selectedFile.size,
                    filePath: data.path,
                    uploadedAt: new Date().toISOString()
                });
                
                // UI 업데이트
                renderUploadedFiles();
                
                // 초기화
                selectedFile = null;
                document.getElementById('fileInput').value = '';
                uploadButton.disabled = true;
                
                alert('파일이 성공적으로 업로드되었습니다!');
                
            } catch (error) {
                console.error('업로드 오류:', error);
                alert('파일 업로드 중 오류가 발생했습니다: ' + error.message);
            } finally {
                uploadProgress.classList.add('hidden');
                uploadProgressBar.style.width = '0%';
            }
        }

        // 업로드된 파일 목록 렌더링
        function renderUploadedFiles() {
            if (!selectedLesson) return;
            
            const uploadedFilesContainer = document.getElementById('uploadedFiles');
            const files = uploadedFiles.get(selectedLesson.id) || [];
            
            if (files.length === 0) {
                uploadedFilesContainer.innerHTML = '<div class="no-files">아직 업로드된 파일이 없습니다.</div>';
                return;
            }
            
            uploadedFilesContainer.innerHTML = files.map(file => `
                <div class="file-item">
                    <div class="file-info">
                        <svg class="file-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                        </svg>
                        <div>
                            <div class="file-name">${file.originalName}</div>
                            <div class="file-size">${formatFileSize(file.fileSize)}</div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="file-action-button download-button" onclick="downloadFile('${file.filePath}', '${file.originalName}')" title="다운로드">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </button>
                        <button class="file-action-button delete-button" onclick="deleteFile(${file.id})" title="삭제">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- 오디오 컨트롤 -->
                <div class="audio-controls">
                    <button class="play-pause-button" onclick="toggleAudioPlayback('${file.filePath}', '${file.originalName}')" title="재생/일시정지">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h1m4 0h1m-6-8h8a2 2 0 012 2v8a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2z"></path>
                        </svg>
                    </button>
                    
                    <div class="audio-info">
                        <div class="audio-title">${file.originalName}</div>
                        <div class="audio-progress">
                            <div class="progress-bar-audio" onclick="seekAudio(event)">
                                <div class="progress-fill-audio"></div>
                            </div>
                            <div class="time-display">0:00 / 0:00</div>
                        </div>
                    </div>
                    
                    <div class="volume-control">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                        </svg>
                        <input type="range" class="volume-slider" min="0" max="100" value="70" onchange="setVolume(this.value)">
                    </div>
                </div>
            `).join('');
        }

        // 파일 크기 포맷팅 함수
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 시간 포맷팅 함수
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // 오디오 재생/일시정지 함수
        async function toggleAudioPlayback(filePath, fileName) {
            try {
                // 해당 파일의 오디오 엘리먼트 가져오기 또는 생성
                let audio = audioElements.get(filePath);
                
                if (!audio) {
                    // 새로운 오디오 엘리먼트 생성
                    const { data } = await supabaseClient.storage
                        .from('lesson-recordings')
                        .createSignedUrl(filePath, 3600);
                    
                    if (data?.signedUrl) {
                        audio = new Audio(data.signedUrl);
                        audioElements.set(filePath, audio);
                        
                        // 오디오 이벤트 리스너 추가
                        setupAudioEventListeners(audio, filePath, fileName);
                    }
                }

                if (audio) {
                    // 다른 파일들이 재생 중이면 모두 정지
                    audioElements.forEach((otherAudio, otherPath) => {
                        if (otherPath !== filePath && !otherAudio.paused) {
                            otherAudio.pause();
                            updatePlayButtonForFile(otherPath, false);
                        }
                    });

                    // 현재 파일 재생/일시정지 토글
                    if (audio.paused) {
                        await audio.play();
                        updatePlayButtonForFile(filePath, true);
                    } else {
                        audio.pause();
                        updatePlayButtonForFile(filePath, false);
                    }
                }
            } catch (error) {
                console.error('재생 오류:', error);
                alert('파일 재생 중 오류가 발생했습니다.');
                updatePlayButtonForFile(filePath, false);
            }
        }

        // 오디오 이벤트 리스너 설정
        function setupAudioEventListeners(audio, filePath, fileName) {
            if (!audio) return;

            // 재생 시작
            audio.addEventListener('play', () => {
                updatePlayButtonForFile(filePath, true);
            });

            // 일시정지
            audio.addEventListener('pause', () => {
                updatePlayButtonForFile(filePath, false);
            });

            // 재생 종료
            audio.addEventListener('ended', () => {
                updatePlayButtonForFile(filePath, false);
                updateProgressBarForFile(filePath, 0);
            });

            // 시간 업데이트
            audio.addEventListener('timeupdate', () => {
                if (audio.duration) {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    updateProgressBarForFile(filePath, progress);
                    updateTimeDisplayForFile(filePath, audio.currentTime, audio.duration);
                }
            });

            // 메타데이터 로드
            audio.addEventListener('loadedmetadata', () => {
                updateTimeDisplayForFile(filePath, 0, audio.duration);
            });

            // 오류 처리
            audio.addEventListener('error', (e) => {
                console.error('오디오 오류:', e);
                updatePlayButtonForFile(filePath, false);
            });
        }

        // 특정 파일의 재생 버튼 상태 업데이트
        function updatePlayButtonForFile(filePath, isPlaying) {
            const buttons = document.querySelectorAll(`[onclick*="${filePath}"]`);
            buttons.forEach(button => {
                if (button.classList.contains('play-pause-button')) {
                    if (isPlaying) {
                        button.classList.add('playing');
                        button.innerHTML = `
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        `;
                    } else {
                        button.classList.remove('playing');
                        button.innerHTML = `
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h1m4 0h1m-6-8h8a2 2 0 012 2v8a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2z"></path>
                            </svg>
                        `;
                    }
                }
            });
        }

        // 특정 파일의 진행률 바 업데이트
        function updateProgressBarForFile(filePath, progress) {
            const audioControls = document.querySelectorAll(`[onclick*="${filePath}"]`);
            audioControls.forEach(control => {
                const progressBar = control.closest('.audio-controls')?.querySelector('.progress-fill-audio');
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
            });
        }

        // 특정 파일의 시간 표시 업데이트
        function updateTimeDisplayForFile(filePath, currentTime, duration) {
            const audioControls = document.querySelectorAll(`[onclick*="${filePath}"]`);
            audioControls.forEach(control => {
                const timeDisplay = control.closest('.audio-controls')?.querySelector('.time-display');
                if (timeDisplay) {
                    timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
                }
            });
        }

        // 재생 버튼 상태 업데이트 (기존 함수 유지)
        function updatePlayButton(isPlaying) {
            const playButtons = document.querySelectorAll('.play-pause-button');
            playButtons.forEach(button => {
                if (isPlaying) {
                    button.classList.add('playing');
                    button.innerHTML = `
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    `;
                } else {
                    button.classList.remove('playing');
                    button.innerHTML = `
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h1m4 0h1m-6-8h8a2 2 0 012 2v8a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2z"></path>
                        </svg>
                    `;
                }
            });
        }

        // 진행률 바 업데이트
        function updateProgressBar(progress) {
            const progressBars = document.querySelectorAll('.progress-fill-audio');
            progressBars.forEach(bar => {
                bar.style.width = `${progress}%`;
            });
        }

        // 시간 표시 업데이트
        function updateTimeDisplay(currentTime, duration) {
            const timeDisplays = document.querySelectorAll('.time-display');
            timeDisplays.forEach(display => {
                display.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
            });
        }

        // 오디오 정지 함수
        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                updatePlayButton(false);
                updateProgressBar(0);
                updateTimeDisplay(0, currentAudio.duration || 0);
            }
        }

        // 볼륨 조절 함수
        function setVolume(volume) {
            // 모든 오디오 엘리먼트의 볼륨 조절
            audioElements.forEach(audio => {
                audio.volume = volume / 100;
            });
        }

        // 진행률 바 클릭으로 시간 이동
        function seekAudio(event) {
            const progressBar = event.currentTarget;
            const audioControls = progressBar.closest('.audio-controls');
            const playButton = audioControls.querySelector('.play-pause-button');
            const onclickAttr = playButton.getAttribute('onclick');
            
            // onclick 속성에서 filePath 추출
            const filePathMatch = onclickAttr.match(/toggleAudioPlayback\('([^']+)'/);
            if (filePathMatch) {
                const filePath = filePathMatch[1];
                const audio = audioElements.get(filePath);
                
                if (audio && audio.duration) {
                    const rect = progressBar.getBoundingClientRect();
                    const clickX = event.clientX - rect.left;
                    const percentage = clickX / rect.width;
                    const newTime = percentage * audio.duration;
                    
                    audio.currentTime = newTime;
                }
            }
        }

        // 파일 다운로드 함수
        async function downloadFile(filePath, originalName) {
            try {
                const { data } = await supabaseClient.storage
                    .from('lesson-recordings')
                    .createSignedUrl(filePath, 3600);
                
                if (data?.signedUrl) {
                    const link = document.createElement('a');
                    link.href = data.signedUrl;
                    link.download = originalName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            } catch (error) {
                console.error('다운로드 오류:', error);
                alert('파일 다운로드 중 오류가 발생했습니다.');
            }
        }

        // 파일 삭제 함수
        async function deleteFile(fileId) {
            if (!confirm('정말로 이 파일을 삭제하시겠습니까?')) return;
            
            try {
                const files = uploadedFiles.get(selectedLesson.id) || [];
                const file = files.find(f => f.id === fileId);
                
                if (!file) return;
                
                // Supabase Storage에서 파일 삭제
                const { error: storageError } = await supabaseClient.storage
                    .from('lesson-recordings')
                    .remove([file.filePath]);
                
                if (storageError) {
                    throw storageError;
                }
                
                // 데이터베이스에서 파일 정보 삭제
                const { error: dbError } = await supabaseClient
                    .from('lesson_files')
                    .delete()
                    .eq('file_path', file.filePath);
                
                if (dbError) {
                    throw dbError;
                }
                
                // 로컬 상태 업데이트
                const updatedFiles = files.filter(f => f.id !== fileId);
                uploadedFiles.set(selectedLesson.id, updatedFiles);
                
                // 오디오 엘리먼트 정리
                if (audioElements.has(file.filePath)) {
                    const audio = audioElements.get(file.filePath);
                    audio.pause();
                    audioElements.delete(file.filePath);
                }
                
                // UI 업데이트
                renderUploadedFiles();
                
                alert('파일이 성공적으로 삭제되었습니다.');
                
            } catch (error) {
                console.error('삭제 오류:', error);
                alert('파일 삭제 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 강의별 파일 목록 로드 함수
        async function loadLessonFiles(lessonId) {
            try {
                const { data, error } = await supabaseClient
                    .from('lesson_files')
                    .select('*')
                    .eq('lesson_id', lessonId)
                    .order('uploaded_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                const files = data.map(file => ({
                    id: new Date(file.uploaded_at).getTime(),
                    fileName: file.file_name,
                    originalName: file.original_name,
                    fileSize: file.file_size,
                    filePath: file.file_path,
                    uploadedAt: file.uploaded_at
                }));
                
                uploadedFiles.set(lessonId, files);
                
            } catch (error) {
                console.error('파일 목록 로드 오류:', error);
                uploadedFiles.set(lessonId, []);
            }
        }

        // 연습 달력 생성 함수
        function generatePracticeCalendar(lessonId) {
            const calendar = document.getElementById('practiceCalendar');
            const today = new Date();
            
            // lessonId를 숫자로 변환
            const numericLessonId = parseInt(lessonId);
            const lesson = lessons.find(l => l.id === numericLessonId);
            
            if (!lesson) {
                console.error('강의를 찾을 수 없습니다:', lessonId);
                console.log('현재 lessons 배열:', lessons);
                console.log('찾고 있는 lessonId:', lessonId, '변환된 ID:', numericLessonId);
                return;
            }
            
            const lessonDate = new Date(lesson.date);
            
            // 현재 날짜가 포함된 주의 일요일부터 2주간 보여주기 (올해 달력)
            const startDate = new Date(today);
            const dayOfWeek = startDate.getDay(); // 0=일요일, 1=월요일, ..., 6=토요일
            startDate.setDate(startDate.getDate() - dayOfWeek); // 해당 주의 일요일로 이동
            
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 14); // 2주 후
            
            const practiceDates = practiceRecords.get(lessonId) || [];
            
            let calendarHTML = '';
            
            // 요일 헤더
            const weekDays = ['일', '월', '화', '수', '목', '금', '토'];
            weekDays.forEach(day => {
                calendarHTML += `<div style="text-align: center; font-weight: 600; color: #6b7280; padding: 0.25rem;">${day}</div>`;
            });
            
            // 달력 날짜들 (2주간, 요일에 맞게 배치)
            for (let week = 0; week < 2; week++) { // 2주
                for (let day = 0; day < 7; day++) { // 7일
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + (week * 7) + day);
                    
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const dayNum = currentDate.getDate();
                    
                    let dayClass = 'practice-day';
                    let isClickable = true;
                    
                    if (currentDate.toDateString() === today.toDateString()) {
                        dayClass += ' today';
                    } else if (currentDate < today) {
                        dayClass += ' past';
                    } else {
                        dayClass += ' future';
                    }
                    
                    if (practiceDates.includes(dateStr)) {
                        dayClass += ' practiced';
                    }
                    
                    const clickHandler = `onclick="togglePractice('${lessonId}', '${dateStr}')"`;
                    
                    calendarHTML += `<div class="${dayClass}" ${clickHandler}>${dayNum}</div>`;
                }
            }
            
            calendar.innerHTML = calendarHTML;
        }

        // 연습 체크 토글 함수
        async function togglePractice(lessonId, dateStr) {
            try {
                // lessonId를 숫자로 변환
                const numericLessonId = parseInt(lessonId);
                const lesson = lessons.find(l => l.id === numericLessonId);
                
                if (!lesson) {
                    console.error('강의를 찾을 수 없습니다:', lessonId);
                    console.log('현재 lessons 배열:', lessons);
                    console.log('찾고 있는 lessonId:', lessonId, '변환된 ID:', numericLessonId);
                    return;
                }
                
                const practiceDates = practiceRecords.get(numericLessonId) || [];
                const isPracticed = practiceDates.includes(dateStr);
                
                if (isPracticed) {
                    // 연습 체크 해제
                    const updatedDates = practiceDates.filter(d => d !== dateStr);
                    practiceRecords.set(numericLessonId, updatedDates);
                    await savePracticeRecord(numericLessonId, dateStr, false);
                } else {
                    // 연습 체크
                    practiceDates.push(dateStr);
                    practiceRecords.set(numericLessonId, practiceDates);
                    await savePracticeRecord(numericLessonId, dateStr, true);
                }
                
                // 달력과 통계 업데이트
                generatePracticeCalendar(numericLessonId);
                updatePracticeStats(numericLessonId);
                
            } catch (error) {
                console.error('연습 체크 오류:', error);
                alert('연습 체크 저장 중 오류가 발생했습니다.');
            }
        }

        // 연습 기록을 데이터베이스에 저장
        async function savePracticeRecord(lessonId, dateStr, practiced) {
            try {
                if (practiced) {
                    // 연습 기록 추가
                    const { error } = await supabaseClient
                        .from('practice_records')
                        .insert({
                            lesson_id: lessonId,
                            practice_date: dateStr,
                            practiced: true
                        });
                    
                    if (error) throw error;
                } else {
                    // 연습 기록 삭제
                    const { error } = await supabaseClient
                        .from('practice_records')
                        .delete()
                        .eq('lesson_id', lessonId)
                        .eq('practice_date', dateStr);
                    
                    if (error) throw error;
                }
            } catch (error) {
                console.error('연습 기록 저장 오류:', error);
                throw error;
            }
        }

        // 연습 통계 업데이트
        function updatePracticeStats(lessonId) {
            const practiceDates = practiceRecords.get(lessonId) || [];
            const totalDays = practiceDates.length;
            
            // 연속 연습일 계산
            const today = new Date();
            let streak = 0;
            
            for (let i = 0; i < 30; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateStr = checkDate.toISOString().split('T')[0];
                
                if (practiceDates.includes(dateStr)) {
                    streak++;
                } else {
                    break;
                }
            }
            
            // DOM 요소가 존재하는지 확인
            const streakElement = document.getElementById('practiceStreak');
            const totalElement = document.getElementById('practiceTotal');
            
            if (streakElement) {
                streakElement.textContent = `${streak}일 연속`;
            }
            if (totalElement) {
                totalElement.textContent = `총 ${totalDays}일 연습`;
            }
        }

        // 강의별 연습 기록 로드
        async function loadPracticeRecords(lessonId) {
            try {
                const { data, error } = await supabaseClient
                    .from('practice_records')
                    .select('practice_date')
                    .eq('lesson_id', lessonId)
                    .eq('practiced', true);
                
                if (error) {
                    console.error('연습 기록 로드 오류:', error);
                    return;
                }
                
                const practiceDates = data ? data.map(record => record.practice_date) : [];
                practiceRecords.set(lessonId, practiceDates);
                
            } catch (error) {
                console.error('연습 기록 로드 오류:', error);
            }
        }

        // 드래그 앤 드롭 이벤트 처리
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('fileUploadArea');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith('audio/')) {
                        selectedFile = file;
                        document.getElementById('uploadButton').disabled = false;
                    } else {
                        alert('오디오 파일만 업로드할 수 있습니다.');
                    }
                }
            });
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            // 완료 상태를 데이터베이스에서 로드
            await loadLessonCompletions();
            
            updateProgress();
            renderLessons();
            setupDragAndDrop();
        });
    </script>
</body>
</html>
